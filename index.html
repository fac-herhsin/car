<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>何鑫實業 - 派車管理系統 (GitHub 雲端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        .form-grid td { padding: 10px; border: 1px solid #cbd5e1; }
        .label-bg { background-color: #f8fafc; font-weight: bold; width: 110px; font-size: 0.8rem; color: #475569; }
        .sign-td { width: 20%; height: 90px; vertical-align: top; padding: 5px; border: 1px solid #cbd5e1; font-weight: bold; font-size: 0.75rem; }
        @media print { .no-print { display: none !important; } }
        
        /* 刪除按鈕樣式 */
        .btn-delete-row {
            padding: 6px;
            border-radius: 6px;
            color: #94a3b8;
            transition: all 0.2s;
        }
        .btn-delete-row:hover {
            color: #ef4444;
            background-color: #fee2e2;
        }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-6 text-slate-900">

    <!-- 列表頁面 -->
    <div id="view-list" class="max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-black text-slate-800 flex items-center gap-2">
                <i data-lucide="truck" class="text-blue-600"></i> 何鑫實業 - 派車管理 (雲端同步)
            </h1>
            <div id="auth-status" class="text-xs text-slate-400 font-bold">系統連線中...</div>
            <button id="btn-new-record" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg shadow font-bold hover:bg-blue-700 transition">新增派車單</button>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-50 border-b">
                    <tr>
                        <th class="p-4 text-xs font-bold text-slate-400">日期</th>
                        <th class="p-4 text-xs font-bold text-slate-400">工案代號</th>
                        <th class="p-4 text-xs font-bold text-slate-400">下貨點</th>
                        <th class="p-4 text-xs font-bold text-slate-400">廠商</th>
                        <th class="p-4 text-xs font-bold text-slate-400 text-right">操作</th>
                    </tr>
                </thead>
                <tbody id="main-tbody">
                    <tr><td colspan="5" class="p-10 text-center text-slate-300 font-bold">正在從雲端載入資料...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 表單頁面 -->
    <div id="view-form" class="max-w-5xl mx-auto hidden">
        <div class="flex justify-between items-center mb-6 no-print">
            <button id="btn-back-to-list" class="text-slate-500 font-bold hover:text-blue-600">← 返回列表</button>
            <div class="flex gap-4">
                <button id="btn-print" class="bg-white border border-slate-300 px-6 py-2 rounded-lg font-bold shadow-sm">列印單據</button>
                <button id="btn-save" class="bg-blue-600 text-white px-8 py-2 rounded-lg font-bold shadow-lg hover:bg-blue-700">儲存並同步</button>
            </div>
        </div>

        <form id="dispatchForm" class="bg-white p-10 rounded-xl shadow-lg border border-slate-300">
            <input type="hidden" id="edit-id" value="">
            <div class="text-center mb-8 border-b-4 border-double border-black pb-4">
                <h2 class="text-2xl font-black tracking-widest">何 鑫 實 業 派 車 申 請 單</h2>
            </div>
            <table class="w-full form-grid border-collapse mb-6 text-sm">
                <tr>
                    <td class="label-bg">工案代號</td>
                    <td><input type="text" id="f-projectCode" class="w-full outline-none font-black text-blue-700"></td>
                    <td class="label-bg">申請人</td>
                    <td><input type="text" id="f-applicant" class="w-full outline-none font-bold"></td>
                </tr>
                <tr>
                    <td class="label-bg">派車日期</td>
                    <td><input type="date" id="f-date" class="w-full outline-none font-bold"></td>
                    <td class="label-bg">配合時間</td>
                    <td><input type="time" id="f-time" class="w-full outline-none font-bold"></td>
                </tr>
                <tr>
                    <td class="label-bg">配合廠商</td>
                    <td><input type="text" id="f-vendor" class="w-full outline-none font-black text-amber-700"></td>
                    <td class="label-bg">報價金額</td>
                    <td><input type="number" id="f-price" class="w-full outline-none font-bold"></td>
                </tr>
                <tr>
                    <td class="label-bg">車種需求</td>
                    <td>
                        <select id="f-carType" class="bg-transparent border-b outline-none font-bold">
                            <option value="貨車">貨車</option><option value="吊卡">吊卡</option><option value="吊車">吊車</option><option value="板車">板車</option><option value="回頭車">回頭車</option>
                        </select>
                        <input type="number" id="f-carCount" value="1" class="w-10 text-center border-b outline-none"> 台
                    </td>
                    <td class="label-bg">規格尺寸</td>
                    <td><input type="text" id="f-carSize" class="w-full outline-none font-bold"></td>
                </tr>
                <tr>
                    <td class="label-bg">聯絡人</td>
                    <td><input type="text" id="f-contactPerson" class="w-full outline-none font-bold"></td>
                    <td class="label-bg">聯絡電話</td>
                    <td><input type="text" id="f-contactPhone" class="w-full outline-none font-bold"></td>
                </tr>
                <tr>
                    <td class="label-bg">起點</td>
                    <td><input type="text" id="f-pickup" value="公司" class="w-full outline-none font-bold"></td>
                    <td class="label-bg">下貨名稱</td>
                    <td><input type="text" id="f-destination" class="w-full outline-none font-black"></td>
                </tr>
                <tr>
                    <td class="label-bg">下貨地址</td>
                    <td colspan="3"><input type="text" id="f-destAddr" class="w-full outline-none font-bold"></td>
                </tr>
            </table>

            <div class="mb-6">
                <div class="bg-slate-100 px-4 py-1 font-bold text-xs border border-b-0 text-slate-500">品項明細</div>
                <div id="item-container" class="border p-4 border-slate-300 rounded-b"></div>
                <button type="button" id="btn-add-item" class="mt-2 text-blue-600 text-xs font-bold no-print">+ 新增品項</button>
            </div>

            <div class="mb-8">
                <div class="bg-slate-100 px-4 py-1 font-bold text-xs border border-b-0 text-slate-500">備註</div>
                <textarea id="f-notes" rows="2" class="w-full border p-2 text-sm outline-none border-slate-300 font-bold rounded-b"></textarea>
            </div>

            <table class="w-full border-collapse">
                <tr class="text-center font-bold">
                    <td class="label-bg border p-1 text-[10px]">申請人</td>
                    <td class="label-bg border p-1 text-[10px]">主管簽核</td>
                    <td class="label-bg border p-1 text-[10px]">車輛出貨完畢</td>
                    <td class="label-bg border p-1 text-[10px]">採購</td>
                    <td class="label-bg border p-1 text-[10px]">會計</td>
                </tr>
                <tr>
                    <td class="sign-td"></td><td class="sign-td"></td><td class="sign-td"></td><td class="sign-td"></td><td class="sign-td"></td>
                </tr>
            </table>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hexin-fleet-github';
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let user = null;
        let records = [];

        // 頁面切換
        const showView = (view) => {
            document.getElementById('view-list').classList.toggle('hidden', view !== 'list');
            document.getElementById('view-form').classList.toggle('hidden', view !== 'form');
            if (view === 'list') renderTable();
            window.scrollTo(0, 0);
        };

        // 新增品項
        const addItem = (n='', q=1, u='件') => {
            const container = document.getElementById('item-container');
            const div = document.createElement('div');
            div.className = "flex gap-2 item-row mb-2";
            div.innerHTML = `
                <input type="text" placeholder="品名/規格" value="${n}" class="i-name flex-1 border rounded p-2 text-sm outline-none">
                <input type="number" value="${q}" class="i-qty w-16 border rounded p-2 text-sm text-center outline-none">
                <input type="text" value="${u}" class="i-unit w-16 border rounded p-2 text-sm text-center outline-none">
                <button type="button" class="remove-item-btn text-gray-300 hover:text-red-500 px-1 no-print">✕</button>
            `;
            div.querySelector('.remove-item-btn').onclick = () => div.remove();
            container.appendChild(div);
        };

        // 編輯紀錄
        const editRecord = (id) => {
            const r = records.find(x => x.id === id);
            document.getElementById('edit-id').value = id || '';
            document.getElementById('item-container').innerHTML = '';
            
            const fields = ['projectCode','applicant','date','time','vendor','price','carType','carCount','carSize','contactPerson','contactPhone','pickup','destination','destAddr','notes'];
            
            if (r) {
                fields.forEach(f => {
                    const el = document.getElementById('f-' + f);
                    if (el) el.value = r[f] || '';
                });
                if (r.items && r.items.length) {
                    r.items.forEach(i => addItem(i.name, i.qty, i.unit));
                } else {
                    addItem();
                }
            } else {
                fields.forEach(f => {
                    const el = document.getElementById('f-' + f);
                    if (!el) return;
                    if (f === 'carCount') el.value = 1;
                    else if (f === 'pickup') el.value = '公司';
                    else if (f === 'carType') el.value = '貨車';
                    else el.value = '';
                });
                addItem();
            }
            showView('form');
        };

        // 刪除紀錄
        const deleteRecord = async (id, projectCode) => {
            if (!user) return;
            if (!confirm(`確定要刪除工案 [${projectCode}] 的派車單嗎？此動作無法復原。`)) return;

            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dispatches', id));
            } catch (e) {
                console.error(e);
                alert("刪除失敗");
            }
        };

        // 表格渲染
        const renderTable = () => {
            const tbody = document.getElementById('main-tbody');
            if (!tbody) return;
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-slate-300 font-bold">雲端暫無資料。</td></tr>';
                return;
            }

            let html = "";
            records.forEach(r => {
                html += `
                    <tr class="row-item border-b hover:bg-slate-50 cursor-pointer transition" data-id="${r.id}">
                        <td class="p-4 text-sm font-bold text-slate-600">${r.date || '未填'}</td>
                        <td class="p-4 font-black text-blue-700">${r.projectCode || 'N/A'}</td>
                        <td class="p-4 text-sm font-medium">${r.destination || ''}</td>
                        <td class="p-4 text-sm text-slate-500">${r.vendor || ''}</td>
                        <td class="p-4 text-right">
                            <button class="btn-delete-row" onclick="event.stopPropagation(); window.handleDelete('${r.id}', '${r.projectCode}')">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
            if (window.lucide) window.lucide.createIcons();
        };

        // 全域刪除處理函數 (供 HTML 內 onclick 使用)
        window.handleDelete = deleteRecord;

        // 事件委託監聽器 (處理編輯)
        document.getElementById('main-tbody').addEventListener('click', (e) => {
            const row = e.target.closest('.row-item');
            if (row && !e.target.closest('button')) {
                const recordId = row.getAttribute('data-id');
                editRecord(recordId);
            }
        });

        const saveData = async () => {
            if (!user) return;
            const editId = document.getElementById('edit-id').value;
            const data = { updatedAt: serverTimestamp() };
            const fields = ['projectCode','applicant','date','time','vendor','price','carType','carCount','carSize','contactPerson','contactPhone','pickup','destination','destAddr','notes'];
            fields.forEach(f => { data[f] = document.getElementById('f-' + f).value; });
            data.items = Array.from(document.querySelectorAll('.item-row')).map(row => ({
                name: row.querySelector('.i-name').value,
                qty: row.querySelector('.i-qty').value,
                unit: row.querySelector('.i-unit').value
            })).filter(i => i.name);

            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'dispatches');
                if (editId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dispatches', editId), data);
                } else {
                    data.createdAt = serverTimestamp();
                    data.createdBy = user.uid;
                    await addDoc(colRef, data);
                }
                showView('list');
            } catch (e) {
                console.error(e);
                alert("儲存失敗");
            }
        };

        const printForm = () => {
            const form = document.getElementById('dispatchForm');
            const clone = form.cloneNode(true);
            clone.querySelectorAll('input, select, textarea').forEach(el => {
                const val = el.value || '';
                const span = document.createElement('span');
                span.className = "inline-block border-b border-slate-300 px-1 font-bold min-w-[20px]";
                span.innerText = val;
                el.parentNode.replaceChild(span, el);
            });
            const printWin = window.open('', '_blank');
            printWin.document.write(`<html><head><title>派車單</title><script src="https://cdn.tailwindcss.com"><\/script><style>body{padding:40px;}table{width:100%;border-collapse:collapse;}td{border:1px solid black;padding:8px;}.label-bg{background:#f1f5f9;font-weight:bold;width:110px;font-size:12px;}.sign-td{height:80px;width:20%;}.no-print{display:none;}</style></head><body>${clone.innerHTML}<script>window.onload=()=>{window.print();setTimeout(()=>window.close(),500);}<\/script></body></html>`);
            printWin.document.close();
        };

        // 初始化與綁定
        document.getElementById('btn-new-record').onclick = () => editRecord('');
        document.getElementById('btn-back-to-list').onclick = () => showView('list');
        document.getElementById('btn-save').onclick = () => saveData();
        document.getElementById('btn-print').onclick = () => printForm();
        document.getElementById('btn-add-item').onclick = () => addItem();

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            const statusEl = document.getElementById('auth-status');
            if (user) {
                statusEl.innerText = "雲端連線：正常";
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'dispatches');
                onSnapshot(q, (snap) => {
                    records = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                                 .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    renderTable();
                }, (err) => {
                    statusEl.innerText = "連線異常";
                });
            }
        });

        window.onload = () => {
            if (window.lucide) window.lucide.createIcons();
            initAuth();
        };
    </script>
</body>
</html>
