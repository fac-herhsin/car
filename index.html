<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>何鑫實業 - 派車管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .hidden { display: none !important; }
        .form-input { width: 100%; border: 1px solid #e2e8f0; padding: 0.6rem; border-radius: 0.5rem; outline: none; transition: 0.2s; font-size: 0.9rem; }
        .form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .section-title { font-size: 0.9rem; font-weight: 700; color: #1e40af; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem; }
        .checkbox-card { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; cursor: pointer; transition: 0.2s; font-size: 0.85rem; background: #fff; }
        .checkbox-card:hover { background-color: #f8fafc; }
        .bg-pickup { background-color: #f0fdf4; border: 1px solid #dcfce7; }
        .bg-dropoff { background-color: #fef2f2; border: 1px solid #fee2e2; }
    </style>
</head>
<body class="bg-[#f8fafc] min-h-screen text-slate-800">

    <header class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="showView('dashboard')">
                <div class="bg-blue-600 p-2 rounded-lg text-white"><i data-lucide="truck" class="w-5 h-5"></i></div>
                <h1 class="font-bold text-lg text-slate-900">何鑫實業</h1>
            </div>
            <button id="nav-btn" onclick="openForm()" class="bg-blue-600 text-white px-5 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg hover:bg-blue-700 active:scale-95 transition">
                <i data-lucide="plus" class="w-4 h-4"></i> 新增派車單
            </button>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4 md:p-6">
        
        <div id="view-dashboard" class="space-y-4">
            <div id="list-container" class="grid gap-3"></div>
        </div>

        <div id="view-form" class="hidden">
            <form id="dispatchForm" class="bg-white rounded-2xl shadow-sm border p-6 md:p-10 space-y-10">
                <input type="hidden" id="edit-index" value="-1">

                <section>
                    <div class="section-title"><i data-lucide="calendar"></i> 排程/配合時間 <span class="text-red-500 font-normal">*(可多個)</span></div>
                    <div id="schedule-box" class="space-y-3"></div>
                    <button type="button" onclick="addScheduleRow()" class="w-full mt-4 py-2 border border-blue-200 border-dashed rounded-xl text-blue-600 text-sm font-bold hover:bg-blue-50 transition flex justify-center items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> 新增配合時段
                    </button>
                </section>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <section>
                        <div class="section-title"><i data-lucide="user"></i> 申請人資訊</div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs text-slate-500 mb-1 block">申請部門</label>
                                <select name="department" class="form-input"><option>廠務部</option><option>工務部</option></select></div>
                            <div><label class="text-xs text-slate-500 mb-1 block">申請人 *</label>
                                <input type="text" name="applicant" required class="form-input" placeholder="請輸入姓名"></div>
                        </div>
                    </section>
                    <section>
                        <div class="section-title"><i data-lucide="file-text"></i> 專案/業主資訊</div>
                        <div class="space-y-4">
                            <input type="text" name="projectCode" required class="form-input" placeholder="工案代號 *">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="text" name="owner" class="form-input" placeholder="業主/現場聯絡人">
                                <input type="text" name="phone" class="form-input" placeholder="聯絡電話">
                            </div>
                        </div>
                    </section>
                </div>

                <section>
                    <div class="section-title"><i data-lucide="truck"></i> 車輛與特殊需求</div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div><label class="text-xs text-slate-500 mb-1 block">車輛類別 (車種)</label>
                            <select name="vehicleCategory" class="form-input">
                                <option>回頭車</option><option selected>貨車</option><option>吊卡</option><option>吊車</option><option>板車</option>
                            </select></div>
                        <input type="text" name="vehicleSpec" class="form-input mt-5" placeholder="車輛規格 (選填)">
                        <input type="number" name="vehicleCount" value="1" class="form-input mt-5 text-center">
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <label class="checkbox-card"><input type="checkbox" name="needs" value="需車尾門"> 需車尾門</label>
                        <label class="checkbox-card"><input type="checkbox" name="needs" value="需油壓板車"> 需油壓板車</label>
                        <label class="checkbox-card"><input type="checkbox" name="needs" value="需手拉吊車"> 需手拉吊車</label>
                        <label class="checkbox-card"><input type="checkbox" name="needs" value="需吊籃"> 需吊籃</label>
                    </div>
                </section>

                <section>
                    <div class="section-title"><i data-lucide="map-pin"></i> 路線行程與地點</div>
                    <div class="flex flex-col md:flex-row gap-4 items-center mb-4">
                        <div class="flex-1 w-full bg-pickup p-4 rounded-xl">
                            <label class="block text-xs font-bold text-green-700 mb-2">上貨地點 (FROM)</label>
                            <input type="text" name="pickup" value="公司" class="form-input border-green-200">
                        </div>
                        <i data-lucide="arrow-right" class="hidden md:block text-slate-300"></i>
                        <div class="flex-1 w-full bg-dropoff p-4 rounded-xl">
                            <label class="block text-xs font-bold text-red-700 mb-2">下貨地點名稱 (TO NAME)</label>
                            <input type="text" name="dropoffName" required class="form-input border-red-200" placeholder="例：台積電F18工地">
                        </div>
                    </div>
                    <textarea name="dropoffAddr" required rows="2" class="form-input" placeholder="詳細下貨地址 *"></textarea>
                </section>

                <section>
                    <div class="section-title"><i data-lucide="list"></i> 出貨品項清單 <span class="text-red-500 font-normal text-xs">*(至少一項)</span></div>
                    <div id="item-box" class="space-y-2 mb-3"></div>
                    <button type="button" onclick="addItemRow()" class="w-full py-2 border rounded-lg text-blue-600 text-xs font-bold hover:bg-slate-50">+ 新增品項</button>
                </section>

                <section class="bg-blue-50/50 p-6 rounded-2xl border border-blue-100">
                    <div class="section-title text-blue-800 border-blue-200"><i data-lucide="tag"></i> 廠商與報價 (調度員專用)</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="vendor" class="form-input" placeholder="承接廠商">
                        <input type="number" name="price" class="form-input" placeholder="報價金額 (NT$)">
                    </div>
                </section>

                <div class="flex justify-end items-center gap-6 pt-10 border-t">
                    <button type="button" onclick="showView('dashboard')" class="text-slate-500 font-bold">取消</button>
                    <button type="submit" class="bg-blue-600 text-white px-10 py-3 rounded-xl font-bold shadow-xl shadow-blue-200 active:scale-95 transition">確認送出</button>
                </div>
            </form>
        </div>
    </main>

    <script>
        // 記憶功能關鍵：從 localStorage 讀取
        let records = JSON.parse(localStorage.getItem('he_xin_records')) || [];

        function showView(v) {
            document.getElementById('view-dashboard').classList.toggle('hidden', v !== 'dashboard');
            document.getElementById('view-form').classList.toggle('hidden', v !== 'form');
            if(v === 'dashboard') renderList();
            window.scrollTo(0,0);
            lucide.createIcons();
        }

        function addScheduleRow(d = {date: new Date().toISOString().split('T')[0], time: "09:00"}) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-2";
            div.innerHTML = `<input type="date" name="s_date[]" value="${d.date}" class="form-input flex-1"><input type="time" name="s_time[]" value="${d.time}" class="form-input w-32"><button type="button" onclick="this.parentElement.remove()" class="text-slate-300 p-2 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
            document.getElementById('schedule-box').appendChild(div);
            lucide.createIcons();
        }

        function addItemRow(i = {name: "", qty: 1, unit: "箱"}) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-2";
            div.innerHTML = `<input type="text" name="i_name[]" value="${i.name}" placeholder="品項名稱" class="form-input flex-1"><input type="number" name="i_qty[]" value="${i.qty}" class="form-input w-20 text-center"><input type="text" name="i_unit[]" value="${i.unit}" class="form-input w-16 text-center"><button type="button" onclick="this.parentElement.remove()" class="text-slate-300 p-2 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
            document.getElementById('item-box').appendChild(div);
            lucide.createIcons();
        }

        function openForm(idx = -1) {
            const f = document.getElementById('dispatchForm');
            f.reset();
            document.getElementById('schedule-box').innerHTML = "";
            document.getElementById('item-box').innerHTML = "";
            document.getElementById('edit-index').value = idx;

            if(idx > -1) {
                const r = records[idx];
                f.applicant.value = r.applicant; f.projectCode.value = r.projectCode; f.dropoffName.value = r.dropoffName; f.dropoffAddr.value = r.dropoffAddr;
                f.vendor.value = r.vendor; f.price.value = r.price; f.vehicleCategory.value = r.vehicleCategory;
                r.schedules.forEach(s => addScheduleRow(s));
                r.items.forEach(it => addItemRow(it));
                f.querySelectorAll('input[name="needs"]').forEach(c => c.checked = r.needs.includes(c.value));
            } else {
                addScheduleRow(); addItemRow();
            }
            showView('form');
        }

        document.getElementById('dispatchForm').onsubmit = function(e) {
            e.preventDefault();
            const fd = new FormData(this);
            const data = {
                applicant: fd.get('applicant'), projectCode: fd.get('projectCode'),
                dropoffName: fd.get('dropoffName'), dropoffAddr: fd.get('dropoffAddr'),
                vehicleCategory: fd.get('vehicleCategory'), vendor: fd.get('vendor'), price: fd.get('price'),
                needs: fd.getAll('needs'),
                schedules: fd.getAll('s_date[]').map((d, i) => ({date: d, time: fd.getAll('s_time[]')[i]})),
                items: fd.getAll('i_name[]').map((n, i) => ({name: n, qty: fd.getAll('i_qty[]')[i], unit: fd.getAll('i_unit[]')[i]}))
            };

            const idx = parseInt(document.getElementById('edit-index').value);
            if(idx > -1) records[idx] = data; else records.push(data);

            // 記憶功能關鍵：存回 localStorage
            localStorage.setItem('he_xin_records', JSON.stringify(records));
            showView('dashboard');
        };

        function renderList() {
            const container = document.getElementById('list-container');
            if(records.length === 0) { container.innerHTML = `<div class="text-center py-20 text-slate-400">尚無派車資料</div>`; return; }
            container.innerHTML = records.map((r, i) => `
                <div class="bg-white p-5 rounded-xl border flex justify-between items-center group hover:border-blue-300 transition shadow-sm">
                    <div>
                        <div class="text-[10px] text-blue-500 font-bold mb-1">${r.schedules[0].date}</div>
                        <div class="font-bold text-slate-900">${r.projectCode} - ${r.applicant}</div>
                        <div class="text-xs text-slate-500">${r.dropoffName}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openForm(${i})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"><i data-lucide="square-pen" class="w-5 h-5"></i></button>
                        <button onclick="deleteRec(${i})" class="p-2 text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                </div>
            `).reverse().join('');
            lucide.createIcons();
        }

        window.deleteRec = (i) => { if(confirm('確定刪除？')) { records.splice(i, 1); localStorage.setItem('he_xin_records', JSON.stringify(records)); renderList(); } };

        window.onload = () => { renderList(); lucide.createIcons(); };
    </script>
</body>
</html>
